openapi: 3.0.3
info:
  title: Accounting Service - Payments API
  description: |
    REST API for recording payments received from customers. 
    Implements double-entry accounting with support for partial, full, and overpayments.
  version: 1.0.0
  contact:
    name: Accounting Service Team
    email: accounting@example.com

servers:
  - url: https://api.example.com/v1
    description: Production
  - url: https://api-staging.example.com/v1
    description: Staging

security:
  - BearerAuth: []

tags:
  - name: Payments
    description: Payment recording operations

paths:
  /payments:
    post:
      tags:
        - Payments
      summary: Record a payment
      description: |
        Records a payment received from a customer to reduce Accounts Receivable balance. 
        Creates two ledger entries:
        - Debit: Cash/Bank (increases cash received)
        - Credit: Accounts Receivable (reduces what customer owes)
        
        **Authorization**: Requires valid JWT with tenant context.
        
        **Idempotency**: Uses Payment Reference ID as natural idempotency key. Duplicate submissions for same Payment Reference ID will be rejected with 409 Conflict.
        
        **Payment Types**: Supports partial payments, full payments, and overpayments (resulting in credit balance).
        
        **Tenant Isolation**: Payments are automatically associated with tenant from JWT claims.
        
        **Performance Target**: p95 latency < 100ms
      operationId: recordPayment
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RecordPaymentRequest'
            examples:
              fullPayment:
                summary: Full Payment
                value:
                  paymentReferenceId: "PAY-2026-02-06-12345"
                  accountId: "3fa85f64-5717-4562-b3fc-2c963f66afa6"
                  amount: 145.50
                  paymentDate: "2026-02-06T16:45:00Z"
                  paymentMode: "CreditCard"
              partialPayment:
                summary: Partial Payment
                value:
                  paymentReferenceId: "PAY-2026-02-06-67890"
                  accountId: "3fa85f64-5717-4562-b3fc-2c963f66afa6"
                  amount: 50.00
                  paymentDate: "2026-02-06T10:15:00Z"
                  paymentMode: "BankTransfer"
              overpayment:
                summary: Overpayment (Credit Balance)
                value:
                  paymentReferenceId: "PAY-2026-02-06-11111"
                  accountId: "3fa85f64-5717-4562-b3fc-2c963f66afa6"
                  amount: 200.00
                  paymentDate: "2026-02-06T18:30:00Z"
                  paymentMode: "Check"
      responses:
        '201':
          description: Payment recorded successfully
          headers:
            Location:
              description: URI to query the account balance
              schema:
                type: string
                example: /v1/accounts/3fa85f64-5717-4562-b3fc-2c963f66afa6
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RecordPaymentResponse'
              examples:
                fullPayment:
                  summary: Full Payment (Balance â†’ Zero)
                  value:
                    paymentReferenceId: "PAY-2026-02-06-12345"
                    accountId: "3fa85f64-5717-4562-b3fc-2c963f66afa6"
                    amount: 145.50
                    previousBalance: 145.50
                    newBalance: 0.00
                    balanceType: "Zero"
                    ledgerEntryIds:
                      - "1a2b3c4d-5e6f-4a5b-9c8d-7e6f5a4b3c2d"
                      - "2b3c4d5e-6f7a-4b5c-1d2e-8f7a6b5c4d3e"
                    recordedAt: "2026-02-06T16:45:10Z"
                partialPayment:
                  summary: Partial Payment (Balance Remaining)
                  value:
                    paymentReferenceId: "PAY-2026-02-06-67890"
                    accountId: "3fa85f64-5717-4562-b3fc-2c963f66afa6"
                    amount: 50.00
                    previousBalance: 145.50
                    newBalance: 95.50
                    balanceType: "Outstanding"
                    ledgerEntryIds:
                      - "3c4d5e6f-7a8b-4c5d-2e3f-9a8b7c6d5e4f"
                      - "4d5e6f7a-8b9c-4d5e-3f4a-1b2c3d4e5f6a"
                    recordedAt: "2026-02-06T10:15:05Z"
                overpayment:
                  summary: Overpayment (Credit Balance)
                  value:
                    paymentReferenceId: "PAY-2026-02-06-11111"
                    accountId: "3fa85f64-5717-4562-b3fc-2c963f66afa6"
                    amount: 200.00
                    previousBalance: 145.50
                    newBalance: -54.50
                    balanceType: "Credit"
                    ledgerEntryIds:
                      - "5e6f7a8b-9c1d-4e5f-3a4b-2c3d4e5f6a7b"
                      - "6f7a8b9c-1d2e-4f5a-4b5c-3d4e5f6a7b8c"
                    recordedAt: "2026-02-06T18:30:12Z"
        '400':
          description: Bad request - validation error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
              examples:
                invalidAmount:
                  summary: Invalid Amount
                  value:
                    type: "https://api.example.com/problems/validation-error"
                    title: "Validation Error"
                    status: 400
                    detail: "Amount must be greater than zero"
                    instance: "/v1/payments"
                    errors:
                      amount: ["Must be greater than zero"]
                accountInactive:
                  summary: Account Inactive
                  value:
                    type: "https://api.example.com/problems/account-inactive"
                    title: "Account Inactive"
                    status: 400
                    detail: "Cannot record payments to inactive account"
                    instance: "/v1/payments"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          description: Account not found
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
              example:
                type: "https://api.example.com/problems/account-not-found"
                title: "Account Not Found"
                status: 404
                detail: "Account with ID 3fa85f64-5717-4562-b3fc-2c963f66afa6 not found"
                instance: "/v1/payments"
        '409':
          description: Conflict - duplicate payment (idempotency violation)
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
              example:
                type: "https://api.example.com/problems/duplicate-payment"
                title: "Duplicate Payment"
                status: 409
                detail: "Payment with reference ID PAY-2026-02-06-12345 already recorded for this account"
                instance: "/v1/payments"
                existingLedgerEntryIds:
                  - "1a2b3c4d-5e6f-4a5b-9c8d-7e6f5a4b3c2d"
                  - "2b3c4d5e-6f7a-4b5c-1d2e-8f7a6b5c4d3e"
        '500':
          $ref: '#/components/responses/InternalServerError'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token containing tenant ID and user context in claims

  schemas:
    RecordPaymentRequest:
      type: object
      required:
        - paymentReferenceId
        - accountId
        - amount
        - paymentDate
      properties:
        paymentReferenceId:
          type: string
          minLength: 1
          maxLength: 255
          description: Unique identifier for the payment (natural idempotency key)
          example: "PAY-2026-02-06-12345"
        accountId:
          type: string
          format: uuid
          description: Account receiving the payment
          example: "3fa85f64-5717-4562-b3fc-2c963f66afa6"
        amount:
          type: number
          format: decimal
          minimum: 0.01
          maximum: 999999999999999.9999
          description: Payment amount in USD (must be positive)
          example: 145.50
        paymentDate:
          type: string
          format: date-time
          description: Date and time when payment was received (UTC)
          example: "2026-02-06T16:45:00Z"
        paymentMode:
          type: string
          maxLength: 100
          description: Optional payment method (stored in ledger metadata)
          example: "CreditCard"
          enum: [CreditCard, DebitCard, BankTransfer, Check, Cash, Other]

    RecordPaymentResponse:
      type: object
      properties:
        paymentReferenceId:
          type: string
          description: Payment reference identifier that was recorded
          example: "PAY-2026-02-06-12345"
        accountId:
          type: string
          format: uuid
          description: Account that received the payment
          example: "3fa85f64-5717-4562-b3fc-2c963f66afa6"
        amount:
          type: number
          format: decimal
          description: Amount that was paid
          example: 145.50
        previousBalance:
          type: number
          format: decimal
          description: Account balance before payment was recorded
          example: 145.50
        newBalance:
          type: number
          format: decimal
          description: Account balance after payment was recorded (negative = credit balance)
          example: 0.00
        balanceType:
          type: string
          enum: [Outstanding, Zero, Credit]
          description: |
            Type of balance after payment:
            - Outstanding: Positive balance (customer still owes money)
            - Zero: Balance is exactly zero (fully paid)
            - Credit: Negative balance (customer has overpaid/has credit)
          example: "Zero"
        ledgerEntryIds:
          type: array
          items:
            type: string
            format: uuid
          description: IDs of the two ledger entries created (debit + credit)
          minItems: 2
          maxItems: 2
          example:
            - "1a2b3c4d-5e6f-4a5b-9c8d-7e6f5a4b3c2d"
            - "2b3c4d5e-6f7a-4b5c-1d2e-8f7a6b5c4d3e"
        recordedAt:
          type: string
          format: date-time
          description: Timestamp when payment was recorded (UTC)
          example: "2026-02-06T16:45:10Z"

    ProblemDetails:
      type: object
      description: RFC 9457 Problem Details for HTTP APIs
      properties:
        type:
          type: string
          format: uri
          description: URI reference identifying the problem type
          example: "https://api.example.com/problems/validation-error"
        title:
          type: string
          description: Short, human-readable summary of the problem
          example: "Validation Error"
        status:
          type: integer
          description: HTTP status code
          example: 400
        detail:
          type: string
          description: Human-readable explanation specific to this occurrence
          example: "Amount must be greater than zero"
        instance:
          type: string
          format: uri
          description: URI reference identifying the specific occurrence
          example: "/v1/payments"
        errors:
          type: object
          additionalProperties:
            type: array
            items:
              type: string
          description: Validation errors by field
          example:
            amount: ["Must be greater than zero"]

  responses:
    Unauthorized:
      description: Unauthorized - missing or invalid JWT token
      content:
        application/problem+json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'
          example:
            type: "https://api.example.com/problems/unauthorized"
            title: "Unauthorized"
            status: 401
            detail: "Valid JWT token required"
            instance: "/v1/payments"

    InternalServerError:
      description: Internal server error
      content:
        application/problem+json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'
          example:
            type: "https://api.example.com/problems/internal-server-error"
            title: "Internal Server Error"
            status: 500
            detail: "An unexpected error occurred while processing your request"
            instance: "/v1/payments"
